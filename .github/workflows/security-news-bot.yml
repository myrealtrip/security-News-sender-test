name: Security News Bot

on:
  schedule:
    # 매 30분마다 실행 (0분, 30분에 실행)
    - cron: '*/30 * * * *'
  workflow_dispatch:  # 수동 실행 가능

jobs:
  check-news:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Run security news bot
        env:
          # GitHub Secrets를 환경변수로 매핑 (자동 인식 안 됨, 명시적으로 설정 필요!)
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}
          USE_AI_JUDGMENT: ${{ secrets.USE_AI_JUDGMENT || 'true' }}
          AI_PROVIDER: ${{ secrets.AI_PROVIDER || 'anthropic' }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL || 'claude-3-5-haiku-20241022' }}
          # OpenAI 사용 시 (주석 해제):
          # OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # OPENAI_MODEL: ${{ secrets.OPENAI_MODEL || 'gpt-4o-mini' }}
          # 프롬프트 파일 경로 (선택사항, 기본값 사용 시 생략 가능)
          # AI_PROMPT_FILE_FIRST_STAGE: ${{ secrets.AI_PROMPT_FILE_FIRST_STAGE || 'ai_prompt_first_stage.txt' }}
          # AI_PROMPT_FILE_SECOND_STAGE: ${{ secrets.AI_PROMPT_FILE_SECOND_STAGE || 'ai_prompt_second_stage.txt' }}
        run: |
          # 로그 디렉토리 생성
          mkdir -p logs
          # 실행 로그를 파일로 저장 (stdout과 stderr 모두, 타임스탬프 포함)
          LOG_FILE="logs/execution_$(date +%Y%m%d_%H%M%S).log"
          python aitest.py 2>&1 | tee "$LOG_FILE"
          # 최신 실행 로그를 execution.log로도 저장 (최신 로그 확인용)
          cp "$LOG_FILE" execution.log
      
      - name: Commit and push state file and logs
        if: always()
        run: |
          git add state.aitest.json
          # 발송 로그 파일도 커밋 (있는 경우)
          if [ -f debug_sent_entries.json ]; then
            git add debug_sent_entries.json
          fi
          # 실행 로그 파일들도 커밋 (logs 디렉토리 전체)
          if [ -d logs ] && [ -n "$(ls -A logs 2>/dev/null)" ]; then
            git add logs/
          fi
          # 최신 실행 로그도 커밋 (있는 경우)
          if [ -f execution.log ]; then
            git add execution.log
          fi
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update state file and logs [skip ci]"
            git push
          fi
